rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Allow user to read/write their own data
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isRecipient(snapId) {
      // Check if user is in recipientIds array
      let snap = get(/databases/$(database)/documents/Snaps/$(snapId)).data;
      return isSignedIn() && (request.auth.uid in snap.recipientIds || request.auth.uid == snap.senderId);
    }
    
    // ============================================================================
    // USER COLLECTION
    // ============================================================================
    match /Users/{userId} {
      allow read: if isSignedIn() && userId == request.auth.uid;
      allow write: if isOwner(userId);
      allow create: if isOwner(userId);
      
      // User subcollections
      match /{document=**} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }
    
    // ============================================================================
    // SNAPS COLLECTION
    // ============================================================================
    match /Snaps/{snapId} {
      allow create: if isSignedIn();
      
      allow read: if isSignedIn() && (
        // Own snap
        resource.data.senderId == request.auth.uid ||
        // Recipient of snap
        request.auth.uid in resource.data.recipientIds ||
        // Story snap visible to friends
        (resource.data.storyVisible == true && 
         resource.data.expiresAt > request.time)
      );
      
      allow update: if isOwner(resource.data.senderId) && 
        // Only allow updating viewCount, reactionCount, replyCount
        (request.resource.data.senderId == resource.data.senderId &&
         request.resource.data.createdAt == resource.data.createdAt &&
         request.resource.data.mediaUrl == resource.data.mediaUrl);
      
      allow delete: if isOwner(resource.data.senderId) ||
        // Auto-delete after expiration
        (resource.data.expiresAt < request.time && 
         request.auth.uid == resource.data.senderId);
      
      // Snap views subcollection
      match /Views/{viewId} {
        allow read: if isOwner(resource.data.userId);
        allow create: if isSignedIn() && 
          request.resource.data.userId == request.auth.uid;
      }
      
      // Snap reactions subcollection
      match /Reactions/{reactionId} {
        allow read: if isRecipient(snapId);
        allow create: if isSignedIn();
        allow delete: if isSignedIn() && 
          resource.data.userId == request.auth.uid;
      }
      
      // Snap replies subcollection
      match /Replies/{replyId} {
        allow read: if isRecipient(snapId);
        allow create: if isSignedIn();
      }
    }
    
    // ============================================================================
    // CHAT SYSTEM
    // ============================================================================
    match /Conversations/{conversationId} {
      // Read if you're a participant
      allow read: if isSignedIn() && 
        request.auth.uid in resource.data.participantIds;
      
      // Create if you're a participant
      allow create: if isSignedIn() && 
        request.auth.uid in request.resource.data.participantIds;
      
      // Update if you're a participant
      allow update: if isSignedIn() && 
        request.auth.uid in resource.data.participantIds;
      
      // Messages subcollection
      match /Messages/{messageId} {
        allow read: if isSignedIn() && 
          request.auth.uid in get(/databases/$(database)/documents/Conversations/$(conversationId)).data.participantIds;
        
        allow create: if isSignedIn() &&
          request.resource.data.senderId == request.auth.uid &&
          request.auth.uid in get(/databases/$(database)/documents/Conversations/$(conversationId)).data.participantIds;
        
        allow update: if isSignedIn() && 
          resource.data.senderId == request.auth.uid;
        
        allow delete: if isSignedIn() && 
          resource.data.senderId == request.auth.uid;
      }
    }
    
    // ============================================================================
    // STORIES COLLECTION (For photo stories, not snap stories)
    // ============================================================================
    match /Stories/{storyId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && 
        request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && 
        resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && 
        resource.data.userId == request.auth.uid;
      
      // Story items
      match /Items/{itemId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && 
          request.auth.uid == get(/databases/$(database)/documents/Stories/$(storyId)).data.userId;
      }
    }
    
    // ============================================================================
    // RELATIONSHIPS COLLECTION
    // ============================================================================
    match /Users/{userId}/Friends/{friendId} {
      allow read: if isSignedIn();
      allow write: if isOwner(userId);
    }
    
    match /Users/{userId}/Blocked/{blockedId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    // ============================================================================
    // NOTIFICATIONS COLLECTION
    // ============================================================================
    match /Notifications/{notificationId} {
      allow read: if isSignedIn() && 
        resource.data.userId == request.auth.uid;
      
      allow create: if isSignedIn();
      
      allow update: if isSignedIn() && 
        resource.data.userId == request.auth.uid;
      
      allow delete: if isSignedIn() && 
        resource.data.userId == request.auth.uid;
    }
    
    // ============================================================================
    // DEFAULT DENY
    // ============================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
