rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ============================================================
    // HELPER FUNCTIONS
    // ============================================================
    
    // Check if user is authenticated
    function isAuth() {
      return request.auth != null;
    }
    
    // Validate file size (in bytes)
    function validFileSize(maxBytes) {
      return request.resource.size <= maxBytes;
    }
    
    // Validate image content type
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    // Validate specific image types (jpg, png, gif, webp)
    function isValidImageType() {
      return request.resource.contentType in [
        'image/jpeg',
        'image/png',
        'image/gif',
        'image/webp'
      ];
    }

    // ============================================================
    // SNAPS: Chat images between two users
    // ============================================================
    
    // Path: /snaps/{chatId}/{filename}
    // Chat ID format is uid1_uid2 (sorted alphabetically)
    match /snaps/{chatId}/{allPaths=**} {
      // Read: Only chat members (UID in chatId)
      allow read: if isAuth() && 
                    chatId.matches('.*' + request.auth.uid + '.*');
      
      // Write: Only chat members, with validation
      allow write: if isAuth() && 
                     chatId.matches('.*' + request.auth.uid + '.*') &&
                     // Must be an image
                     isValidImageType() &&
                     // Max 10MB per snap
                     validFileSize(10 * 1024 * 1024);
    }

    // ============================================================
    // STORIES: User-posted stories visible to friends
    // ============================================================
    
    // Path: /stories/{authorId}/{filename}
    match /stories/{authorId}/{allPaths=**} {
      // Read: Any authenticated user can read story files
      // (Firestore rules handle access control via recipientIds)
      allow read: if isAuth();
      
      // Write: Only the author can upload to their directory
      allow write: if isAuth() && 
                     request.auth.uid == authorId &&
                     // Must be an image
                     isValidImageType() &&
                     // Max 10MB per story image
                     validFileSize(10 * 1024 * 1024);
    }

    // ============================================================
    // AVATARS: User profile images (future use)
    // ============================================================
    
    // Path: /avatars/{userId}/{filename}
    match /avatars/{userId}/{allPaths=**} {
      // Read: Anyone authenticated can view avatars
      allow read: if isAuth();
      
      // Write: Only owner can upload
      allow write: if isAuth() && 
                     request.auth.uid == userId &&
                     isValidImageType() &&
                     // Max 5MB for avatars
                     validFileSize(5 * 1024 * 1024);
    }

    // ============================================================
    // CATCH-ALL: Deny everything else
    // ============================================================
    
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
